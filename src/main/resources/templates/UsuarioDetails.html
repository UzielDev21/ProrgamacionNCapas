<html xmlns: th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{Layout}">
    <head>
        <title>UsuarioDetails</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" th:href="@{/css/styleDetails.css}">
    </head>

    <!-----------------------------------------------------------------------------ENCABEZADOS DE LA TABLA--------------------------------------------------------------------------->
    <body class="container" style="background-color: beige;" layout:fragment="body">
        <div class="col-12 text-center mb-2 mt-5 divEncabezado" id="divEncabezado">Detalles de Usuario</div>

        <div class="table-responsive divTabla" id="divTabla">
            <table class="table mb-0 tablaUsuarios" id="tableUsuarios">

                <thead class="thHeadEncabezados">
                    <tr>
                        <th class="thUSuario col-2 text-center mg-white border rounded" >USUARIO</th>
                        <th class="thDatosUSuario col-5 text-center mg-white border rounded">Datos del Usuario</th>
                        <th class="thDatosContacto col-5 text-center mg-white border rounded">Datos de Contacto</th>
                    </tr>
                </thead>

                <!-----------------------------------------------------------------------------SECCIÓN DE LA FOTO--------------------------------------------------------------------------->
                <tbody>
                <td rowspan="4" class="tdImg row-md-4 mg-white border rounded p-3">
                    <div class='contenedorImg'>
                        <i class="bi bi-camera btnEditarImagen" type="button" id="btnEditarImagen"></i>

                        <img th:if='${UsuarioId.Imagen != null}' alt="ImgPreview"
                             th:src="@{${#strings.startsWith(UsuarioId.Imagen, 'iVBORw0KGgo')}? 'data:image/png;base64,' + ${UsuarioId.Imagen} : 'data:image/jpg;base64,' + ${UsuarioId.Imagen}}">

                        <img th:if='${UsuarioId.Imagen == null}'
                             src=" https://icon-library.com/images/default-user-icon/default-user-icon-18.jpg">

                        <div id="DatosImagen" class="DatosImagen" style="display: none" >
                            <form>
                                <input type="file" class="form-control mb-2" name="imagenFile" id="imagenFile" accept="image/*">
                                <i class="bi bi-check-circle btnAceptarImg" id="btnAceptarImg"></i>
                            </form>
                        </div>

                        <div class="text-center" ><b><span th:text="${UsuarioId.UserName}"></span></b></div>

                        <div class="btnEditar">
                            <button id="btnEditarDatos" type="button" class="btn btn-outline-dark btnEditarDatos"
                                    data-bs-toggle="modal" data-bs-target="#FormUsuario">Editar Datos</button>
                        </div>

                    </div>
                </td>
                <!-----------------------------------------------------------------------------SECCIÓN DE LOS DATOS--------------------------------------------------------------------------->

                <td class="tdDatosUSuario mg-white border rounded p-3">
                    <div><b>Nombre: </b><span th:text="|${UsuarioId.Nombre} ${UsuarioId.ApellidoPaterno} ${UsuarioId.ApellidoMaterno}|"></span></div>
                    <div><b>Sexo: </b><span th:text="${UsuarioId.Sexo}"></span></div>
                    <div><b>Curp: </b><span th:text="${UsuarioId.Curp}"></span></div>
                    <div><b>Fecha de Nacimiento: </b><span th:text="${UsuarioId.FechaNacimiento}"></span></div>
                    <div><b>Rol: </b><span th:text="${UsuarioId.Rol.NombreRol}"></span></div>
                </td>

                <td class="tdDatosContacto mg-white border rounded p-3">
                    <div><b>Email: </b><span th:text="${UsuarioId.Email}"></span></div>
                    <div><b>Password: </b><span th:text="${UsuarioId.Password}"></span></div>
                    <div><b>Telefono: </b><span th:text="${UsuarioId.Telefono}"></span></div>
                    <div><b>Celular: </b><span th:text="${UsuarioId.Celular}"></span></div>
                </td>

                <!-----------------------------------------------------------------------------DATOS DE DIRECCIÓN--------------------------------------------------------------------------->
                <tr>
                    <td class="tdDireciones mg-white border rounded" colspan="2"><div class="text-center"><b>Direcciones del Usuario</b></div></td>
                </tr>

                <tr class="trDireccion">
                    <td class="tdDireccion Direccion-item overflow-auto mg-white border rounded" colspan="2">
                        <div th:each="Direccion, iterStat : ${UsuarioId.Direcciones}"th:attr="data-id=${Direccion.IdDireccion}">

                            <div th:utext="|Direccion ${iterStat.index + 1}" class="text-center">Dirección</div>
                            <div class="divCalle"><b>Calle: </b><span th:text="${Direccion.Calle}"></span></div>
                            <div class="divNumeroInt"><b>Numero Interior: </b><span th:text="${Direccion.NumeroInterior}"></span></div>
                            <div class="divNumerExt"><b>Numero Exterior: </b><span th:text="${Direccion.NumeroExterior}"></span></div>
                            <div class="divColonia" style="margin-bottom: 15px"><b>Colonia: </b><span th:text="${Direccion.Colonia.NombreColonia}"></span></div>

                            <div class="divBtnAcciones" style="display:flex; flex-direction:column; align-items:center; gap:13px;">
                                <div>
                                    <button type="button" class ="btn btn-outline-warning btnEditarDireccion mb-4" th:attr="data-id=${Direccion.IdDireccion}">Editar Direccion</button>

                                    <button type="button" class ="btn btn-outline-danger btnEliminarDireccion mb-4" th:attr="data-id=${Direccion.IdDireccion}">Eliminar Direccion</button>
                                </div>
                            </div>

                        </div>
                    </td>
                </tr>

                </tbody>
            </table>
        </div>

        <!-----------------------------------------------------------------------------MODAL EDITAR USUARIO--------------------------------------------------------------------------->
        <div class="modal fade" id="FormUsuario" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1" aria_labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">

                    <div class="modal-header modalHeaderUsuario" style="background-color: black;">
                        <h5 style="color: white;">Editar Datos</h5>
                        <button type="button" class="btn btn-outline-light ms-auto" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i></button>
                    </div>

                    <form method="POST" th:action="@{/UsuarioIndex/Details}" th:object="${UsuarioId}" enctype="multipart/form-data">
                        <div class="modal-body">

                            <input  type="hidden" id="IdUsuario" name="IdUsuario" th:field="*{IdUsuario}" style="height: 5px; width: 5px;" >

                            <div class="row mb-2">

                                <div class="col-md-6">
                                    <label for="Nombre">UserName:</label>
                                    <input class="form-control" type="text" id="UserName" name="UserName" placeholder="UserName" th:field="*{UserName}">
                                </div>

                                <div class="col-md-6">
                                    <label for="IdRol">Selecciona tu Rol: </label>
                                    <select class="form-select" aria-label="Default select example" name="IdRol" id="IdRol" th:field="*{Rol.IdRol}" >
                                        <option value=0> Escoge una opcion </option>
                                        <option th:each="rol : ${Roles}" th:value="${rol.IdRol}" th:text="${rol.NombreRol}"></option>
                                    </select>
                                </div>
                            </div>

                            <div>Datos del usuario</div>
                            <div class="divFormDatos card p-3 mb-3">
                                <div class="row mb-2">

                                    <div class="col-md-4">
                                        <label for="Nombre">Nombre:</label>
                                        <input class="form-control" type="text" id="Name" name="Nombre" placeholder="Nombre" th:field="*{Nombre}">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="ApellidoPaterno">Apellido Paterno:</label>
                                        <input class="form-control" type="text" id="ApellidoPaterno"  placeholder="Apellido Paterno" th:field="*{ApellidoPaterno}">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="ApellidoMaterno">Apellido Materno:</label>
                                        <input class="form-control" type="text" id="ApellidoMaterno"  placeholder="Apellido Materno" th:field="*{ApellidoMaterno}">
                                    </div>

                                </div>

                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <label class="" for="FechaNacimiento">Fecha nacimiento</label>
                                        <input class="form-control" type="date" id="FechaNacimiento" name="FechaNacimiento" th:field="*{FechaNacimiento}">
                                    </div>

                                    <div class="col-md-5">
                                        <label for="Curp">Curp: </label>
                                        <input class="form-control" type="text" id="Curp" name="Curp" placeholder="CAJU020521HMCSSZA4" th:field="*{Curp}">
                                    </div>

                                    <div class="col-md-3">
                                        <div for="Sexo" class="mt-1">Sexo:</div>
                                        <input type="radio" id="SexoH" name="Sexo" value="H " th:field="*{Sexo}">
                                        <label for="SexoH">H</label>
                                        <input type="radio" id="SexoM" name="Sexo" value="M " th:field="*{Sexo}">
                                        <label for="SexoM">M</label>
                                    </div>              
                                </div>
                            </div>

                            <div>Datos de Contacto</div>
                            <div class="divFormContacto card p-3"> 

                                <div class="mb-2">
                                    <label for="Email">Email:</label>
                                    <input class="form-control" type="text" id="Email" placeholder="ejemplo@gmail.com" th:field="*{Email}">
                                </div>

                                <div class="row mt-2">

                                    <div class="col-md-6">
                                        <label for="Telefono">Telefono: </label>
                                        <input class="form-control" type="text" id="Telefono" name="Telefono" placeholder="+571 5535804067" th:field="*{Telefono}"> 
                                    </div>

                                    <div class="col-md-6">
                                        <label for="Celular">Celular: </label>
                                        <input class="form-control" type="text" id="Celular" name="Celular" placeholder="+52 5580406030" th:field="*{Celular}">
                                    </div>

                                </div>
                            </div>

                        </div>

                        <div class="modal-footer" style="max-height: auto; max-width: auto;">
                            <button type="submit" class="btn btn-outline-dark"><b>GUARDAR   </b><i class="bi bi-save"></i></button>
                        </div>
                    </form>


                </div>
            </div>
        </div>

        <!-----------------------------------------------------------------------------MODAL CREAR O EDITAR DIRECCION--------------------------------------------------------------------------->
        <button type="button" class="btn btn-outline-primary btnDireccionAdd" id="btnDireccionAdd" 
                data-bs-toggle="modal" data-bs-target="#FormDireccion">Agregar Nueva Direccion</button>

        <div class="modal fade" id="FormDireccion" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header modalHeaderDireccion" id="modalHeaderDireccion">
                        <h5 class="modal-title" id="AgregarDireccionLabel">Direccion</h5>
                        <button type="button" class="btn btn-close" data-bs-dismiss="modal"></button>
                    </div>

<!-----------------------------------------------------------------------------FORMULARIO PARA EDITAR DIRECCIÓN--------------------------------------------------------------------------->                    
                    <form method="POST" th:action="@{/UsuarioIndex/DetailsDireccion/{IdUsuario} (IdUsuario = ${UsuarioId.IdUsuario})}" th:object="${Direccion}" enctype="multipart/form-data">
                        <div class="modal-body">

                            <input  id="IdUsuario" type="hidden" name="IdUsuario" th:value="${UsuarioId.IdUsuario}">
                            <input  id="IdDireccion"  name="IdDireccion" >

                            <div class="col-md-5">
                                <label for="Nombre">Calle:</label>
                                <input class="form-control" type="text" id="Calle" name="Calle" placeholder="Nombre de la Calle" th:field="*{Calle}">
                            </div>

                            <div class="col-md-3">
                                <label for="Nombre">Numero Interior:</label>
                                <input class="form-control" type="text" id="NumeroInterior" name="NumeroInterior" placeholder="Numero Int." th:field="*{NumeroInterior}">
                            </div>

                            <div class="col-md-3">
                                <label for="Nombre">Numero Exterior:</label>
                                <input class="form-control" type="text" id="NumeroExterior" name="NumeroExterior" placeholder="Numero Ext." th:field="*{NumeroExterior}">
                            </div>

                            <div>
                                <label for="ddlPais">Selecciona tu Pais: </label>
                                <select class="form-select" aria-label="Default select example" name="ddlPais" id="ddlPais">
                                    <option value=0> Escoge una opcion </option>
                                    <option th:each="pais : ${Paises}" th:value="${pais.IdPais}" th:text="${pais.Nombre}"></option>
                                </select>
                            </div>

                            <div>
                                <label for="ddlEstado">Selecciona tu Estado: </label>
                                <select class="form-select" aria-label="Default select example" name="ddlEstado" id="ddlEstado" >
                                    <option value=0> Escoge una opcion </option>
                                    <option th:each="estado : ${Estados}" th:value="${estado.IdEstado}" th:text="${estado.Nombre}"> Escoge una opcion </option>
                                </select>
                            </div>

                            <div>
                                <label for="ddlMunicipio">Selecciona tu Municipio: </label>
                                <select class="form-select" aria-label="Default select example" name="ddlMunicipio" id="ddlMunicipio" >
                                    <option value=0> Escoge una opcion </option>
                                    <option th:each="municipio : ${Municipios}" th:value="${municipio.IdMunicipio}" th:text="${municipio.Nombre}"> Escoge una opcion </option>
                                </select>
                            </div>

                            <div>
                                <label for="ddlColonia">Selecciona tu Colonia: </label>
                                <select class="form-select" aria-label="Default select example" name="ddlColonia" id="ddlColonia" th:field="*{Colonia.IdColonia}">
                                    <option value=0> Escoge una opcion </option>
                                    <option th:each="colonia : ${Colonias}" th:value="${colonia.IdColonia}" th:text="${colonia.NombreColonia}"> Escoge una opcion </option>
                                </select>
                            </div>



                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-outline-primary btnGuardarDireccion" id="btnGuardarDireccionNew">Guardar</button>
                            <button type="submit" class="btn btn-outline-warning btnEditarDireccion" id="btnEditarDireccionOld">Editar</button>
                        </div>

                    </form>



                </div>
            </div>
        </div>

        <a th:href="@{/UsuarioIndex}">
            <button type="button" class="btn btn-outline-danger">Regresar</button>
        </a>
        <!-----------------------------------------------------------------------------ALERTAS DE USUARIO--------------------------------------------------------------------------->
        <script th:if="${MsgExito}" th:inline="javascript">
                       Swal.fire({
                           title: [[${MsgExito}]],
                                   icon: "success",
                                   draggable: true
                       });
        </script>

        <script th:if="${MsgError}" th:inline="javascript">
                       Swal.fire({
                           title: [[${MsgError}]],
                                   icon: "success",
                                   draggable: true
                       });
        </script>

<!-----------------------------------------------------------------------------ACCIÓN DE EDITAR --------------------------------------------------------------------------->
        <script>


            $(document).ready(function () {
                $("#btnEditarImagen").click(function () {
                $("#DatosImagen").toggle();
                    });
            });
<!-----------------------------------------------------------------------------CARGA DE LOS DDL--------------------------------------------------------------------------->
            $(document).ready(function () {
                $("#ddlPais").change(function () {
                $.ajax({
                    type: 'GET',
                    url: "/UsuarioIndex/Add/Estados/" + $("#ddlPais").val(),
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {

                        $("#ddlEstado").empty();
                        $("#ddlMunicipio").empty();
                        $("#ddlColonia").empty();
                        $("#ddlEstado").append("<option value=0> Escoge una opcion </option>");
                        $("#ddlMunicipio").append("<option value=0> Escoge una opcion </option>");
                        $("#ddlColonia").append("<option value=0> Escoge una opcion </option>");
                            $.each(data.objects, function (i, estado) {
                            $("#ddlEstado").append("<option value = " + estado.idEstado + ">" + estado.nombre + "</option>");
                                            });
                            },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("No hay información :c ");
                        }
                    });
                });
            });

<!-----------------------------------------------------------------------------DDL ESTADO--------------------------------------------------------------------------->
            $(document).ready(function () {
                $("#ddlEstado").change(function () {
                    $.ajax({
                        type: 'GET',
                        url: "/UsuarioIndex/Add/Municipios/" + $("#ddlEstado").val(),
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {

                            $("#ddlMunicipio").empty();
                            $("#ddlMunicipio").append("<option value=0> Escoge una opcion </option>");
                            $.each(data.objects, function (i, municipio) {
                                $("#ddlMunicipio").append("<option value = " + municipio.idMunicipio + ">" + municipio.nombre + "</option>");
                            });
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("No hay información :c ");
                        }
                    });
                });
            });

<!-----------------------------------------------------------------------------DDL MUNICIPIO--------------------------------------------------------------------------->
            $(document).ready(function () {
                $("#ddlMunicipio").change(function () {
                    $.ajax({
                        type: 'GET',
                        url: "/UsuarioIndex/Add/Colonias/" + $("#ddlMunicipio").val(),
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {

                            $("#ddlColonia").empty();
                            $("#ddlColonia").append("<option value=0> Escoge una opcion </option>");
                            $.each(data.objects, function (i, colonia) {
                                $("#ddlColonia").append("<option value = " + colonia.idColonia + ">" + colonia.nombreColonia + "</option>");
                            });
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("No hay información :c ");
                        }
                    });
                });
            });

<!-----------------------------------------------------------------------------ELIMINAR DIRECCION--------------------------------------------------------------------------->
            $(document).on("click", ".btnEliminarDireccion", function () {
                const idDireccionDelete = $(this).attr("data-id");

                Swal.fire({
                    text: "¿Seguro que quieres eliminar la direccion?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sí, borrar!",
                    cancelButtonText: "Cancelar"
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: "/UsuarioIndex/Details/Direccion/Delete/" + idDireccionDelete,
                            type: 'GET',
                            dataType: "json",
                            success: function (data, textStatus, jqXHR) {
                                Swal.fire({
                                    title: "¡Eliminada!",
                                    text: "La direccion se elimino",
                                    icon: "success"
                                }).then(() => {
                                    location.reload();
                                });
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                Swal.fire("Error", "No se pudo eliminar la dirección", "error");
                            }
                        });
                    }
            });
            });

            
            $(document).on("click", ".btnDireccionAdd", function() {
                
                $("#modalHeaderDireccion").css("background-color","22B7F2");
                $("#btnEditarDireccionOld").hide();
                $("#btnGuardarDireccionNew").show();
                
            });
            
<!-----------------------------------------------------------------------------CARGAR LOS DATOS EN EL MODAL--------------------------------------------------------------------------->
$(document).on("click", ".btnEditarDireccion[data-id]", function () {
                const idDireccion = $(this).attr("data-id");
                console.log(idDireccion);
                $.ajax({
                    url: "/UsuarioIndex/Details/Direccion/" + idDireccion,
                    type: "GET",
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {
                        const direccion = data.object;

                        $("#modalHeaderDireccion").css("background-color","orange");
                        $("#btnGuardarDireccionNew").hide();
                        $("#btnEditarDireccionOld").show();
                        
                        $("#IdDireccion").val(direccion.idDireccion);
                        $("#Calle").val(direccion.calle);
                        $("#NumeroInterior").val(direccion.numeroInterior);
                        $("#NumeroExterior").val(direccion.numeroExterior);
                        $("#ddlPais").val(direccion.colonia.municipio.estado.pais.idPais);
                        $("#ddlEstado").val(direccion.colonia.municipio.estado.idEstado);
                        $("#ddlMunicipio").val(direccion.colonia.municipio.idMunicipio);
                        $("#ddlColonia").val(direccion.colonia.idColonia);
                        
                        $("#FormDireccion").modal("show");
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("No hay datos");
                    }
                });
});
        </script>
  
        
    </body>
</html>
